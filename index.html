<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <title>Giulia ‚Äì Sessioni</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Tailwind CDN (dev ok) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
    <div class="max-w-6xl mx-auto py-6 px-4 sm:py-12 lg:px-8" x-data="app()" x-init="loadSessions()">

        <!-- Header -->
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl sm:text-4xl font-bold text-slate-800 mb-1 sm:mb-2">Diario Allenamento</h1>
                    <p class="text-sm sm:text-base text-slate-600">Monitora i tuoi progressi e benessere</p>
                </div>
                <a href="allenamento.html"
                    class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-5 py-2.5 sm:px-6 sm:py-3 rounded-xl text-sm font-semibold hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg shadow-green-500/30 hover:shadow-xl hover:shadow-green-500/40 transform hover:-translate-y-0.5 text-center">
                    + Nuovo allenamento
                </a>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
            <!-- Weight Chart -->
            <div
                class="lg:col-span-2 bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl shadow-slate-200/50 p-4 sm:p-6 border border-slate-200/50">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-bold text-slate-800">Andamento Peso</h2>
                    <span class="text-xs px-2 sm:px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-medium">Ultimi
                        30gg</span>
                </div>
                <div class="h-48 sm:h-auto">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-1 gap-4">
                <div
                    class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl shadow-blue-500/30 p-4 sm:p-6 text-white">
                    <div class="text-xs sm:text-sm font-medium opacity-90 mb-1">Peso attuale</div>
                    <div class="text-2xl sm:text-3xl font-bold" x-text="currentWeight() || '‚Äî'"></div>
                    <div class="text-xs opacity-75 mt-2" x-text="weightTrend()"></div>
                </div>
                <div
                    class="bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl shadow-xl shadow-orange-500/30 p-4 sm:p-6 text-white">
                    <div class="text-xs sm:text-sm font-medium opacity-90 mb-1">Energia media</div>
                    <div class="text-2xl sm:text-3xl font-bold" x-text="averageEnergy()"></div>
                    <div class="text-xs opacity-75 mt-2">Ultimi 7 giorni</div>
                </div>
            </div>
        </div>

        <!-- FORM NUOVA SESSIONE -->
        <div
            class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl shadow-slate-200/50 p-4 sm:p-6 mb-6 sm:mb-8 border border-slate-200/50">
            <h2 class="text-lg sm:text-xl font-bold text-slate-800 mb-4 sm:mb-5 flex items-center gap-2">
                <span class="w-1.5 h-5 sm:h-6 bg-gradient-to-b from-blue-500 to-indigo-600 rounded-full"></span>
                Nuova Sessione
            </h2>
            <form @submit.prevent="createSession" class="space-y-4 sm:space-y-5">
                <div class="grid sm:grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">Data</label>
                        <input type="date" x-model="form.date"
                            class="w-full border-2 border-slate-200 rounded-xl px-3 sm:px-4 py-2 sm:py-2.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">Ora</label>
                        <input type="time" x-model="form.time"
                            class="w-full border-2 border-slate-200 rounded-xl px-3 sm:px-4 py-2 sm:py-2.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 sm:gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">Peso
                            (kg)</label>
                        <input type="number" step="0.1" x-model="form.weight"
                            class="w-full border-2 border-slate-200 rounded-xl px-2 sm:px-4 py-2 sm:py-2.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none">
                    </div>
                    <div>
                        <label
                            class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">Energia</label>
                        <input type="number" min="1" max="5" x-model="form.energy"
                            class="w-full border-2 border-slate-200 rounded-xl px-2 sm:px-4 py-2 sm:py-2.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none">
                    </div>
                    <div>
                        <label
                            class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">Stress</label>
                        <input type="number" min="1" max="5" x-model="form.stress"
                            class="w-full border-2 border-slate-200 rounded-xl px-2 sm:px-4 py-2 sm:py-2.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">Note</label>
                    <textarea x-model="form.notes"
                        class="w-full border-2 border-slate-200 rounded-xl px-3 sm:px-4 py-2 sm:py-2.5 text-sm focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all outline-none resize-none"
                        rows="3" placeholder="Aggiungi eventuali osservazioni..."></textarea>
                </div>

                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <button type="submit"
                        class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 disabled:opacity-50 disabled:cursor-not-allowed transform hover:-translate-y-0.5"
                        :disabled="loading">
                        <span x-show="!loading">üíæ Salva sessione</span>
                        <span x-show="loading">‚è≥ Salvataggio‚Ä¶</span>
                    </button>
                    <span x-show="errorMessage" x-text="errorMessage"
                        class="text-xs sm:text-sm text-red-600 font-medium bg-red-50 px-3 py-2 rounded-lg text-center"></span>
                </div>
            </form>
        </div>

        <!-- LISTA SESSIONI -->
        <div
            class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl shadow-slate-200/50 p-6 border border-slate-200/50">
            <h2 class="text-xl font-bold text-slate-800 mb-5 flex items-center gap-2">
                <span class="w-1.5 h-6 bg-gradient-to-b from-purple-500 to-pink-600 rounded-full"></span>
                Sessioni Recenti
            </h2>

            <template x-if="sessions.length === 0">
                <div class="text-center py-12">
                    <div class="text-6xl mb-4 opacity-20">üìã</div>
                    <p class="text-slate-500">Nessuna sessione registrata ancora.</p>
                </div>
            </template>

            <div x-show="sessions.length > 0">
                <div class="overflow-x-auto -mx-6 px-6">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b-2 border-slate-200">
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    Data
                                </th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    Peso
                                </th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    Energia
                                </th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    Stress
                                </th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                    Note
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="s in paginatedSessions()" :key="s.id">
                                <tr class="border-b border-slate-100 hover:bg-blue-50/50 transition-colors">
                                    <td class="px-4 py-4 whitespace-nowrap">
                                        <div class="text-sm font-semibold text-slate-800"
                                            x-text="formatDateTime(s.date, s.time)"></div>
                                    </td>
                                    <td class="px-4 py-4 whitespace-nowrap">
                                        <span
                                            class="text-sm font-medium text-slate-700 bg-slate-100 px-3 py-1 rounded-full"
                                            x-text="s.weight ? s.weight + ' kg' : '‚Äî'"></span>
                                    </td>
                                    <td class="px-4 py-4 whitespace-nowrap">
                                        <div class="flex gap-0.5">
                                            <template x-for="i in 5">
                                                <span class="text-lg"
                                                    :class="i <= s.energy ? 'opacity-100' : 'opacity-20'">‚ö°</span>
                                            </template>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 whitespace-nowrap">
                                        <div class="flex gap-0.5">
                                            <template x-for="i in 5">
                                                <span class="text-lg"
                                                    :class="i <= s.stress ? 'opacity-100' : 'opacity-20'">üò∞</span>
                                            </template>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4">
                                        <div class="text-sm text-slate-600 line-clamp-2 max-w-xs"
                                            x-text="s.notes || '‚Äî'"></div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="flex justify-between items-center mt-6 pt-4 border-t-2 border-slate-100">
                    <button @click="prevPage()" :disabled="page === 1"
                        class="px-5 py-2.5 text-sm font-semibold text-slate-700 bg-slate-100 rounded-xl hover:bg-slate-200 disabled:opacity-40 disabled:cursor-not-allowed transition-all">
                        ‚Üê Precedente
                    </button>
                    <span class="text-sm font-medium text-slate-600 bg-slate-100 px-4 py-2 rounded-xl">
                        Pagina <span x-text="page" class="font-bold text-slate-800"></span> di
                        <span x-text="totalPages()" class="font-bold text-slate-800"></span>
                    </span>
                    <button @click="nextPage()" :disabled="page === totalPages()"
                        class="px-5 py-2.5 text-sm font-semibold text-slate-700 bg-slate-100 rounded-xl hover:bg-slate-200 disabled:opacity-40 disabled:cursor-not-allowed transition-all">
                        Successiva ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            const supabaseUrl = 'https://thmaiwbweqyvbczdsxyn.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRobWFpd2J3ZXF5dmJjemRzeHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4Mzg1MjgsImV4cCI6MjA4MDQxNDUyOH0.WTSyb1XXGu7GKG9c9GeGKNtzFxuM33E6nCa2uSRfW9Y';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            return {
                loading: false,
                errorMessage: '',
                page: 1,
                pageSize: 10,
                form: {
                    date: '',
                    time: '',
                    weight: '',
                    energy: 3,
                    stress: 3,
                    notes: ''
                },
                sessions: [],
                async loadSessions() {
                    this.errorMessage = '';
                    const { data, error } = await supabase
                        .from('sessions')
                        .select('*')
                        .order('date', { ascending: false })
                        .limit(100);
                    if (error) {
                        console.error(error);
                        this.errorMessage = 'Errore nel caricare le sessioni';
                        return;
                    }
                    this.sessions = data || [];
                    this.updateChart();
                },
                async createSession() {
                    this.loading = true;
                    this.errorMessage = '';
                    const now = new Date();
                    if (!this.form.date) this.form.date = now.toISOString().slice(0, 10);
                    if (!this.form.time) this.form.time = now.toTimeString().slice(0, 5);
                    const { error } = await supabase
                        .from('sessions')
                        .insert({
                            date: this.form.date,
                            time: this.form.time,
                            weight: this.form.weight ? Number(this.form.weight) : null,
                            energy: this.form.energy ? Number(this.form.energy) : null,
                            stress: this.form.stress ? Number(this.form.stress) : null,
                            umore: null,
                            sleep_time: null,
                            cycle_day: null,
                            cycle_phase: null,
                            notes: this.form.notes || null,
                        });
                    if (error) {
                        console.error(error);
                        this.errorMessage = 'Errore nel salvataggio';
                    } else {
                        const savedDate = this.form.date;
                        this.form = { date: savedDate, time: '', weight: '', energy: 3, stress: 3, notes: '' };
                        await this.loadSessions();
                    }
                    this.loading = false;
                },
                formatDateTime(dateStr, timeStr) {
                    if (!dateStr) return '';
                    const d = new Date(dateStr + 'T' + (timeStr || '00:00'));
                    return d.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: '2-digit' }) + (timeStr ? (' ‚Ä¢ ' + timeStr.slice(0, 5)) : '');
                },
                currentWeight() {
                    const withWeight = this.sessions.filter(s => s.weight);
                    return withWeight.length > 0 ? withWeight[0].weight + ' kg' : null;
                },
                weightTrend() {
                    const withWeight = this.sessions.filter(s => s.weight);
                    if (withWeight.length < 2) return '';
                    const diff = withWeight[0].weight - withWeight[1].weight;
                    return diff > 0 ? `+${diff.toFixed(1)} kg` : `${diff.toFixed(1)} kg`;
                },
                averageEnergy() {
                    const recent = this.sessions.slice(0, 7).filter(s => s.energy);
                    if (recent.length === 0) return '‚Äî';
                    const avg = recent.reduce((sum, s) => sum + s.energy, 0) / recent.length;
                    return avg.toFixed(1) + '/5';
                },
                totalPages() {
                    return Math.max(1, Math.ceil(this.sessions.length / this.pageSize));
                },
                paginatedSessions() {
                    const start = (this.page - 1) * this.pageSize;
                    return this.sessions.slice(start, start + this.pageSize);
                },
                nextPage() { if (this.page < this.totalPages()) this.page++; },
                prevPage() { if (this.page > 1) this.page--; },
                updateChart() {
                    const ctx = document.getElementById('weightChart').getContext('2d');
                    const withWeight = this.sessions.filter(s => s.weight).reverse();
                    const labels = withWeight.map(s => {
                        const d = new Date(s.date);
                        return d.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
                    });
                    const data = withWeight.map(s => s.weight);

                    if (window.weightChartInstance) window.weightChartInstance.destroy();
                    window.weightChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Peso (kg)',
                                data: data,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                borderWidth: 3,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 14 }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                    ticks: { font: { size: 11 } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 11 } }
                                }
                            }
                        }
                    });
                }
            };
        }
    </script>
</body>

</html>