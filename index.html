<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <title>Giulia – Sessioni</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Tailwind CDN (dev ok) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-100 min-h-screen">
    <div class="max-w-3xl mx-auto py-8 px-4" x-data="app()" x-init="loadSessions()">
        <!-- New Workout Button -->
        <div class="flex justify-end mb-4">
            <a href="allenamento.html"
                class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition">Nuovo
                allenamento</a>
        </div>
        <!-- Weight Chart -->
        <div class="bg-white rounded-xl shadow p-4 mb-6">
            <h2 class="font-semibold mb-2">Andamento peso</h2>
            <canvas id="weightChart" height="200"></canvas>
        </div>
        <h1 class="text-2xl font-bold mb-4">Diario sessioni</h1>

        <!-- FORM NUOVA SESSIONE -->
        <div class="bg-white rounded-xl shadow p-4 mb-6">
            <h2 class="font-semibold mb-2">Nuova sessione</h2>
            <form @submit.prevent="createSession" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm">Data</label>
                        <input type="date" x-model="form.date" class="mt-1 w-full border rounded px-2 py-1 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm">Ora</label>
                        <input type="time" x-model="form.time" class="mt-1 w-full border rounded px-2 py-1 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm">Peso (kg)</label>
                        <input type="number" step="0.1" x-model="form.weight"
                            class="mt-1 w-full border rounded px-2 py-1 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm">Energia (1–5)</label>
                        <input type="number" min="1" max="5" x-model="form.energy"
                            class="mt-1 w-full border rounded px-2 py-1 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm">Stress (1–5)</label>
                        <input type="number" min="1" max="5" x-model="form.stress"
                            class="mt-1 w-full border rounded px-2 py-1 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-sm">Note</label>
                    <textarea x-model="form.notes" class="mt-1 w-full border rounded px-2 py-1 text-sm"
                        rows="2"></textarea>
                </div>

                <div class="flex items-center gap-3">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold"
                        :disabled="loading">
                        <span x-show="!loading">Salva sessione</span>
                        <span x-show="loading">Salvataggio…</span>
                    </button>
                    <span x-text="errorMessage" class="text-sm text-red-600"></span>
                </div>
            </form>
        </div>

        <!-- LISTA SESSIONI -->
        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">Sessioni recenti</h2>
            <template x-if="sessions.length === 0">
                <p class="text-sm text-slate-500">Nessuna sessione ancora.</p>
            </template>

            <div x-show="sessions.length > 0">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Data
                                </th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Peso
                                </th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Energia
                                </th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Stress
                                </th>
                                <th scope="col"
                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Note
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="s in paginatedSessions()" :key="s.id">
                                <tr>
                                    <td class="px-3 py-2 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"
                                            x-text="formatDateTime(s.date, s.time)"></div>
                                    </td>
                                    <td class="px-3 py-2 whitespace-nowrap">
                                        <div class="text-sm text-gray-900" x-text="s.weight ? s.weight + ' kg' : '-'">
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 whitespace-nowrap">
                                        <div class="text-sm text-gray-900" x-text="s.energy"></div>
                                    </td>
                                    <td class="px-3 py-2 whitespace-nowrap">
                                        <div class="text-sm text-gray-900" x-text="s.stress"></div>
                                    </td>
                                    <td class="px-3 py-2">
                                        <div class="text-sm text-gray-900 line-clamp-2" x-text="s.notes || '-'"></div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="flex justify-between items-center mt-4">
                    <button @click="prevPage()" :disabled="page === 1"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Precedente
                    </button>
                    <span class="text-sm text-gray-700">
                        Pagina <span x-text="page"></span> di <span x-text="totalPages()"></span>
                    </span>
                    <button @click="nextPage()" :disabled="page === totalPages()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Successiva
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            const supabaseUrl = 'https://thmaiwbweqyvbczdsxyn.supabase.co'; // ← cambia questo
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRobWFpd2J3ZXF5dmJjemRzeHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4Mzg1MjgsImV4cCI6MjA4MDQxNDUyOH0.WTSyb1XXGu7GKG9c9GeGKNtzFxuM33E6nCa2uSRfW9Y'; // ← e questo
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            return {
                loading: false,
                errorMessage: '',
                page: 1,
                pageSize: 10,
                form: {
                    date: '',
                    time: '',
                    weight: '',
                    energy: 3,
                    stress: 3,
                    notes: ''
                },
                sessions: [],
                async loadSessions() {
                    this.errorMessage = '';
                    const { data, error } = await supabase
                        .from('sessions')
                        .select('*')
                        .order('date', { ascending: false })
                        .limit(100); // fetch enough for pagination
                    if (error) {
                        console.error(error);
                        this.errorMessage = 'Errore nel caricare le sessioni';
                        return;
                    }
                    this.sessions = data || [];
                    this.updateChart();
                },
                async createSession() {
                    this.loading = true;
                    this.errorMessage = '';
                    const now = new Date();
                    if (!this.form.date) this.form.date = now.toISOString().slice(0, 10);
                    if (!this.form.time) this.form.time = now.toTimeString().slice(0, 5);
                    const { error } = await supabase
                        .from('sessions')
                        .insert({
                            date: this.form.date,
                            time: this.form.time,
                            weight: this.form.weight ? Number(this.form.weight) : null,
                            energy: this.form.energy ? Number(this.form.energy) : null,
                            stress: this.form.stress ? Number(this.form.stress) : null,
                            umore: null,
                            sleep_time: null,
                            cycle_day: null,
                            cycle_phase: null,
                            notes: this.form.notes || null,
                        });
                    if (error) {
                        console.error(error);
                        this.errorMessage = 'Errore nel salvataggio';
                    } else {
                        const savedDate = this.form.date;
                        this.form = { date: savedDate, time: '', weight: '', energy: 3, stress: 3, notes: '' };
                        await this.loadSessions();
                    }
                    this.loading = false;
                },
                formatDateTime(dateStr, timeStr) {
                    if (!dateStr) return '';
                    const d = new Date(dateStr + 'T' + (timeStr || '00:00'));
                    return d.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: '2-digit' }) + (timeStr ? (' • ' + timeStr.slice(0, 5)) : '');
                },
                // Pagination helpers
                totalPages() {
                    return Math.max(1, Math.ceil(this.sessions.length / this.pageSize));
                },
                paginatedSessions() {
                    const start = (this.page - 1) * this.pageSize;
                    return this.sessions.slice(start, start + this.pageSize);
                },
                nextPage() { if (this.page < this.totalPages()) this.page++; },
                prevPage() { if (this.page > 1) this.page--; },
                // Chart rendering
                updateChart() {
                    const ctx = document.getElementById('weightChart').getContext('2d');
                    const labels = this.sessions.map(s => s.date).reverse();
                    const data = this.sessions.map(s => s.weight).reverse();
                    if (window.weightChartInstance) window.weightChartInstance.destroy();
                    window.weightChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Peso (kg)',
                                data: data,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.3,
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: false } } }
                    });
                }
            };
        }
    </script>
</body>

</html>